<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">

  {# ================= Canonical & Robots =================
     Logica:
     - Gefilterd (params ≠ alleen page): noindex,follow + canonical naar basis-URL
     - Alleen paginering (?page=2+): index,follow + self-canonical met page
     - Ongefilterd: index,follow + canonical naar basis-URL
  #}
  {% set page = request.args.get('page') %}
  {% set allowed_only_page = (request.args|length == 1 and page) %}
  {% set has_filters = (request.args|length > 0 and not allowed_only_page) %}

  {# Basis-URL afhankelijk van context (home, categorie, subcategorie) #}
  {% if actieve_subcategorie %}
    {% set base_url = url_for('abonnement_overzicht',
                              categorie_slug=actieve_subcategorie.categorie.slug,
                              subcategorie_slug=actieve_subcategorie.slug,
                              _external=True) %}
  {% elif actieve_categorie %}
    {% set base_url = url_for('abonnement_overzicht',
                              categorie_slug=actieve_categorie.slug,
                              _external=True) %}
  {% else %}
    {% set base_url = url_for('index', _external=True) %}
  {% endif %}

  {# Canonical-doel bepalen #}
  {% if has_filters %}
    {% set canonical_url = base_url %}
  {% elif allowed_only_page %}
    {% set canonical_url = base_url ~ ('?page=' ~ page) %}
  {% else %}
    {% set canonical_url = base_url %}
  {% endif %}
  <link rel="canonical" href="{{ canonical_url }}">

  {# Robots meta #}
  {% set is_thin = (abonnementen|length == 0) %}
  {% if has_filters or is_thin %}
    <meta name="robots" content="noindex,follow">
  {% else %}
    <meta name="robots" content="index,follow">
  {% endif %}
  {# Optioneel: maximaliseer previews #}
  <meta name="robots" content="max-snippet:-1, max-image-preview:large">

  <!-- Title & Meta description -->
  <title>{{ page_title or "AbboHub - Vind en vergelijk product-abonnementen" }}</title>
  <meta name="description" content="{{ page_description or 'Bij AbboHub vind je snel en eenvoudig alle abonnementen in diverse categorieën. Vergelijk, filter en vind het abonnement dat bij jou past!' }}">

  <!-- Favicon -->
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">

  <!-- Open Graph -->
  <meta property="og:title" content="{{ page_title or 'AbboHub - Vergelijk product-abonnementen eenvoudig' }}">
  <meta property="og:description" content="{{ page_description or 'Vind het abonnement dat bij jou past.' }}">
  <meta property="og:image" content="{{ url_for('static', filename='logo.png', _external=True) }}">
  <meta property="og:url" content="{{ canonical_url }}">
  <meta property="og:type" content="website">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page_title or 'AbboHub' }}">
  <meta name="twitter:description" content="{{ page_description or 'Vergelijk eenvoudig abonnementen per categorie.' }}">
  <meta name="twitter:image" content="{{ url_for('static', filename='logo.png', _external=True) }}">
  {# Twitter kent geen officiële 'twitter:url', og:url volstaat #}

  <!-- Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

  <!-- vendor scripts Google Tag Manager & adsense -->
  <script src="{{ url_for('static', filename='js/vendor.js') }}"></script>

  <!-- Structured data (organisatie) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "AbboHub",
    "url": "https://abbohub.nl",
    "logo": "https://abbohub.nl/static/logo.png"
  }
  </script>

  {# ItemList alleen tonen bij categorie/subcategorie context #}
  {% if actieve_subcategorie or actieve_categorie %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "name": "Abonnementen in categorie {{ actieve_subcategorie.naam if actieve_subcategorie else actieve_categorie.naam }}",
    "description": "{{ (actieve_subcategorie.beschrijving if actieve_subcategorie else actieve_categorie.beschrijving) | striptags | replace('\n', ' ') }}",
    "url": "{{ canonical_url }}",
    "itemListElement": [
      {% for i, abbo in enumerate(abonnementen) %}
      {
        "@type": "ListItem",
        "position": {{ i + 1 }},
        "name": "{{ abbo.naam }}",
        "url": "{{ url_for('abonnement_reviews', slug=abbo.slug, _external=True) }}"
      }{{ "," if not loop.last else "" }}
      {% endfor %}
    ]
  }
  </script>
  {% endif %}

  {# Breadcrumbs JSON-LD (alleen bij actieve context) #}
  {% if actieve_subcategorie or actieve_categorie %}
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {
        "@type":"ListItem",
        "position":1,
        "name":"Home",
        "item":"{{ url_for('index', _external=True) }}"
      }
      {% if actieve_subcategorie %}
      ,{
        "@type":"ListItem",
        "position":2,
        "name": {{ (actieve_subcategorie.categorie.naam if actieve_subcategorie.categorie else "Categorie") | tojson }},
        "item":"{{ url_for('abonnement_overzicht', categorie_slug=actieve_subcategorie.categorie.slug, _external=True) if actieve_subcategorie.categorie else url_for('index', _external=True) }}"
      },{
        "@type":"ListItem",
        "position":3,
        "name": {{ actieve_subcategorie.naam | tojson }},
        "item":"{{ url_for('abonnement_overzicht', categorie_slug=actieve_subcategorie.categorie.slug, subcategorie_slug=actieve_subcategorie.slug, _external=True) }}"
      }
      {% elif actieve_categorie %}
      ,{
        "@type":"ListItem",
        "position":2,
        "name": {{ actieve_categorie.naam | tojson }},
        "item":"{{ url_for('abonnement_overzicht', categorie_slug=actieve_categorie.slug, _external=True) }}"
      }
      {% endif %}
    ]
  }
  </script>
  {% endif %}
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NRGH8P6W"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  {# Context-helpers (zoals in je oorspronkelijke template) #}
  {% if geselecteerde_subcategorie %}
    {% set actieve_subcategorie = unieke_subcategorieën | selectattr("id", "equalto", geselecteerde_subcategorie | int) | list | first %}
  {% endif %}
  {% if geselecteerde_categorie %}
    {% set actieve_categorie = unieke_categorieën | selectattr("id", "equalto", geselecteerde_categorie | int) | list | first %}
  {% endif %}

<!-- HEADER -->
  <header>
    <nav class="main-nav" aria-label="Hoofdnavigatie">
      <ul>
        <li><a href="{{ url_for('index') }}">Home</a></li>
        {% if current_user.is_authenticated %}
          <li><a href="{{ url_for('logout') }}">Uitloggen</a></li>
        {% else %}
          <li><a href="{{ url_for('login') }}">Inloggen</a></li>
        {% endif %}
        <li><a href="/contact">Contact</a></li>
        <li><a href="{{ url_for('blog_overzicht') }}">Abbohub Research</a></li>
      </ul>
    </nav>

    <div class="zoek-filter-container">
      <h1>AbboHub abonnementen</h1>
      <div class="search-row">
        <form method="GET" action="{{ url_for('index') }}" class="zoek-filter-form">
          <input 
            type="text" 
            name="zoekterm" 
            placeholder="Zoek abonnementen..." 
            value="{{ zoekterm }}" 
            aria-label="Zoek abonnementen">
        </form>

        <div class="button-container">
          <div class="dropdown-container">
            <button type="button" class="dropdown-button">Categorieën</button>
            <div class="dropdown-menu">
              <div class="dropdown-item">
                <a href="{{ url_for('index') }}">Alle categorieën</a>
              </div>
              {% for cat in unieke_categorieën %}
                <div class="dropdown-item">
                  <span class="category-button">{{ cat.naam }}</span>
                  <div class="sub-dropdown">
                    <a href="{{ url_for('abonnement_overzicht', categorie_slug=cat.naam|slugify) }}">{{ cat.naam }}</a>
                    {% for subcat in unieke_subcategorieën if subcat.categorie_id == cat.id %}
                      <a href="{{ url_for('abonnement_overzicht', categorie_slug=cat.naam|slugify, subcategorie_slug=subcat.naam|slugify) }}">{{ subcat.naam }}</a>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

          <a href="{{ url_for('vergelijk') }}" class="btn btn-compare" id="vergelijk-knop">Vergelijk</a>

          {% if actieve_subcategorie or actieve_categorie %}
            <a href="javascript:void(0)" onclick="toggleSidebar()" class="btn btn-compare">Categorie Info</a>
          {% endif %}
        </div>
      </div>
    </div>
  </header>

{% if actieve_subcategorie or actieve_categorie %}

<!-- Mobiele overlay -->
<div id="categorieOverlayMobile" class="categorie-overlay-mobile">
  <div class="overlay-content">
    <button onclick="toggleMobileOverlay()" class="overlay-close-btn">×</button>
    <h3>Over {{ actieve_subcategorie.naam if actieve_subcategorie else actieve_categorie.naam }}</h3>
    <div class="overlay-description">
      {{ (actieve_subcategorie.beschrijving if actieve_subcategorie else actieve_categorie.beschrijving) | safe }}
    </div>
  </div>
</div>

<!-- Desktop zijbalk met semantische <aside> -->
<aside id="categorieSidebar" aria-label="Categorie-informatie" style="
  position: fixed;
  top: 0;
  right: -380px;
  width: 340px;
  height: 100vh;
  background: white;
  box-shadow: -2px 0 10px rgba(0,0,0,0.2);
  padding: 20px;
  transition: right 0.3s ease-in-out;
  z-index: 2000;
  overflow-y: auto;
">
<div style="display: flex; justify-content: space-between; align-items: center;">
  <h3>Over {{ actieve_subcategorie.naam if actieve_subcategorie else actieve_categorie.naam }}</h3>
  <button onclick="toggleSidebar()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
</div>
<hr>
<div style="font-size: 0.95rem; line-height: 1.6;">
  {{ (actieve_subcategorie.beschrijving if actieve_subcategorie else actieve_categorie.beschrijving) | safe }}
</div>
</aside>

{% endif %}
<main>
{% if actieve_subcategorie or actieve_categorie %}
<nav class="breadcrumb" aria-label="Broodkruimelpad">
  <a href="{{ url_for('index') }}" class="back-link">Home</a>
  <span aria-hidden="true">›</span>
  {% if actieve_subcategorie %}
    <a href="{{ url_for('abonnement_overzicht', categorie_slug=actieve_subcategorie.categorie.slug) }}">
      {{ actieve_subcategorie.categorie.naam }}
    </a>
    <span aria-hidden="true">›</span>
    <span aria-current="page">{{ actieve_subcategorie.naam }}</span>
  {% elif actieve_categorie %}
    <span aria-current="page">{{ actieve_categorie.naam }}</span>
  {% endif %}
</nav>
{% endif %}

{# Intro alleen tonen als er géén actieve categorie of subcategorie is #}
{% if not actieve_subcategorie and not actieve_categorie
   and not geselecteerde_categorie and not geselecteerde_subcategorie
   and not zoekterm %}
<section class="content-card1 intro-card1" aria-labelledby="intro">
  <h2 id="intro">Welkom bij AbboHub dé plek waar je eenvoudig abonnementen ontdekt, vergelijkt en beter onderbouwde keuzes maakt.</h2>

  <p class="lead">
    AbboHub is dé plek waar je eenvoudig abonnementen ontdekt, vergelijkt en beter onderbouwde keuzes maakt. 
    Je vindt hier een helder overzicht van uiteenlopende productabonnementen, van maaltijdboxen en koffie 
    tot verzorgingsproducten, dierenvoeding en andere slimme thuisbezorgservices. Onze missie is om jou te
    helpen sneller het abonnement te vinden dat écht bij je past.
  </p>

  <p class="lead">
    Op AbboHub bundelen we alle belangrijke informatie op één plek: prijzen, inhoud, voorwaarden, voordelen,
    ervaringen en praktische details. Zo hoef je niet meer zelf tientallen websites af te speuren. Met onze 
    duidelijke vergelijkingen, reviews en tips zie je direct welke aanbieders het beste aansluiten op jouw 
    wensen en situatie.
  </p>

  <p class="lead">
    AbboHub groeit voortdurend. We voegen regelmatig nieuwe abonnementen toe, werken categorieën bij en 
    publiceren diepgaande analyses op onze blog AbboHub Research. Zo blijf jij altijd op de hoogte van trends 
    en nieuwe abonnementsvormen.
  </p>

  <p class="lead">
    Of je nu op zoek bent naar gemak, prijsvoordeel of gewoon benieuwd bent naar de mogelijkheden: 
    met AbboHub vergelijk je sneller, kies je slimmer en blijf je altijd goed geïnformeerd.
  </p>
</section>
{% endif %}


{% if actieve_subcategorie or actieve_categorie %}
<!-- Verborgen SEO-tekst zodat AI/zoekmachines de categorie-info kunnen indexeren -->
<section class="categorie-seo-info" aria-hidden="true" style="position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;">
  <h2>Over {{ actieve_subcategorie.naam if actieve_subcategorie else actieve_categorie.naam }}</h2>
  <div>
    {{ (actieve_subcategorie.beschrijving if actieve_subcategorie else actieve_categorie.beschrijving) | safe }}
  </div>
</section>
{% endif %}
        <div class="abonnementen-container">
            {% if abonnementen %}
                {% for categorie in unieke_categorieën %}
                    {% set categorie_abonnementen = abonnementen_per_categorie[categorie.id] %}
                    {% if categorie_abonnementen or (not geselecteerde_subcategorie and not geselecteerde_categorie and not zoekterm) %}
                    <section class="categorie" data-categorie-id="{{ categorie.id }}">
                      <h2>{{ categorie.naam }}</h2>
                      <div class="categorie-scroll-wrapper">
                        <!-- Linker scroll-pijl -->
                        <div class="scroll-arrow scroll-arrow-left">&lt;</div>
                        <!-- Scrollbare container -->
                        <div class="categorie-scroll-container">
                          <div class="abonnementen-lijst">
                            {% if categorie_abonnementen %}
                              {% for abonnement in categorie_abonnementen %}
                                <article class="abonnement">
                                  <h3>{{ abonnement.naam }}</h3>
                                  {% if abonnement.get_average_score() is not none %}
  {% set score = abonnement.get_average_score() %}
  {% set volle = score | int %}
  {% set halve = (score - volle) >= 0.25 and (score - volle) < 0.75 %}
  {% set leeg = 5 - volle - (1 if halve else 0) %}

  <div class="ster-rating" aria-label="Beoordeling: {{ score }} van 5">
    {% for _ in range(volle) %}<span class="vol-ster">★</span>{% endfor %}
    {% if halve %}<span class="halve-ster">★</span>{% endif %}
    {% for _ in range(leeg) %}<span class="leeg-ster">☆</span>{% endfor %}
    <span class="score-tekst">{{ score | round(1) }}</span>
  </div>
{% endif %}
                                  <div class="flip-container">
                                    <div class="flip-inner">
                                      <div class="flip-front">
                                          {% if abonnement.logo %}
                                            <img 
                                              src="{{ url_for('static', filename='uploads/' ~ abonnement.logo) }}" 
                                              alt="Logo van {{ abonnement.naam }} abonnement - {{ abonnement.subcategorie.naam }}" 
                                              loading="lazy"
                                              class="abonnement-logo"
                                            >
                                          {% else %}
                                            <img 
                                              src="{{ url_for('static', filename='images/placeholder.png') }}" 
                                              alt="Geen logo beschikbaar" 
                                              class="abonnement-logo"
                                            >
                                          {% endif %}
                                      </div>
                                      <div class="flip-back">
                                        <p class="beschrijving">{{ abonnement.beschrijving }}</p>
                                      </div>
                                    </div>
                                  </div>
                                  <span class="subcategorie">{{ abonnement.subcategorie.naam }}</span>
                                  <div class="abonnement-tags">
                                    {% for tag in abonnement.tags %}
                                      <span class="badge">{{ tag.naam }}</span>
                                    {% endfor %}
                                  </div>
                                  <div class="abonnement-acties">
                                    <label>
                                      <input type="checkbox" class="vergelijk-checkbox" value="{{ abonnement.slug }}">
                                      Vergelijk
                                    </label>
                                    <a href="{{ url_for('abonnement_reviews', slug=abonnement.slug) }}"
                                    class="btn-review"
                                    onclick="trackAbboInfo('{{ abonnement.naam }}')">
                                   Abbo info
                                 </a>                                 
                                  </div>
                                </article>
                              {% endfor %}
                            {% else %}
                              <p>Geen abonnementen beschikbaar in deze categorie.</p>
                            {% endif %}
                          </div>
                        </div>
                        <!-- Rechter scroll-pijl -->
                        <div class="scroll-arrow scroll-arrow-right">&gt;</div>
                      </div>
                    </section>                    
                    {% endif %}
                {% endfor %}
            {% else %}
                <p>Geen abonnementen gevonden. Probeer een andere zoekopdracht of filter.</p>
            {% endif %}
        </div>    

        <!-- Chatbot Widget -->
<!-- Knop om de chatbot te openen/sluiten -->
<button id="toggle-chat" class="chat-toggle-btn">Vraag om advies</button>

<!-- Chatbox --> 
<div id="chatbox">
    <div id="chat-header">
      <span>Uw adviseur</span>
      <button id="close-chat">−</button>
    </div>
    <div id="chatlog"></div>
    <div id="user-input">
      <input type="text" id="user-message" placeholder="Typ een bericht...">
      <button id="send-btn">Verstuur</button>
    </div>
  </div>

 <footer class="site-footer">
  <div class="footer-content">
    <p class="affiliate-note">
      Sommige links op AbboHub zijn affiliate links. Wanneer je via zo’n link bestelt, kan AbboHub een kleine commissie ontvangen – 
      <strong>zonder extra kosten voor jou</strong>.
    </p>

    <p class="copyright">
      &copy; 2025 AbboHub. Alle rechten voorbehouden.
    </p>

    <nav class="footer-nav" aria-label="Footer navigatie">
      <ul>
        <li><a href="{{ url_for('privacy_cookieverklaring') }}">Privacy- en Cookieverklaring</a></li>
        <li><a href="{{ url_for('algemene_voorwaarden') }}">Algemene Voorwaarden</a></li>
        <li><a href="{{ url_for('over_abbohub') }}">Over AbboHub</a></li>
        <li><a href="#" onclick="openSettings()">Cookievoorkeuren aanpassen</a></li>
      </ul>
    </nav>
  </div>
</footer>

  
  <!-- Cookiebanner insluiten -->
  {% include 'cookie-banner.html' %}
  <script src="{{ url_for('static', filename='js/index.js') }}"></script> 
            </body>
</html>

