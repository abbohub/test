<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>{{ 'Blog bewerken' if post else 'Nieuw blogbericht' }} - AbboHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    .blog-form-container { max-width: 900px; margin: 30px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.06); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    label { display:block; margin-top: 14px; font-weight: 600; }
    input[type="text"], input[type="url"], textarea, select { width: 100%; padding: 10px; border:1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    textarea { min-height: 160px; }
    select[multiple] { min-height: 160px; }
    .help { font-size: .9rem; color:#666; margin-top: 6px; }
    .btn-primary { margin-top: 18px; width: 100%; padding: 12px; border:none; border-radius: 6px; color:#fff; background:#4CAF50; cursor: pointer; font-weight: 700; }
    .btn-primary:hover { background:#45a049; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    .muted { font-size: .85rem; color:#777; }
  /* Responsive: maak grids 1 kolom op mobiel */
  @media (max-width: 900px) {
    .row { grid-template-columns: 1fr !important; }
    .grid-3 { grid-template-columns: 1fr !important; }
    select[multiple] { min-height: 180px; }
  }

  /* Editor layout */
  .editor-wrap { margin-top: 14px; }
  .editor-label { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .counter { font-size: .85rem; color:#666; white-space:nowrap; }

  /* Sticky actions (altijd ‚ÄúPubliceer‚Äù in beeld) */
  .form-actions {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 12px;
    margin-top: 16px;
    border-top: 1px solid #eee;
  }
  .btn-row { display:flex; gap:10px; }
  .btn-row button { flex: 1; }
  </style>
</head>
<body>

<div class="blog-form-container">
  <h1>{{ 'Blog bewerken' if post else 'Nieuw blogbericht' }}</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <label for="auteur_naam">Auteur (weergavenaam)</label>
<input
  type="text"
  id="auteur_naam"
  name="auteur_naam"
  value="{{ post.auteur_naam if post else '' }}"
  placeholder="Bijv. AbboHub Redactie of Tim"
/>
    <label for="titel">Titel</label>
    <input type="text" id="titel" name="titel" required value="{{ post.titel if post else '' }}">

    <label for="inhoud">Inhoud (Markdown)</label>
<textarea id="inhoud" name="inhoud" placeholder="Schrijf hier je artikel...">{{ post.inhoud if post else '' }}</textarea>
<p class="help">
  Gebruik: <code>##</code> voor kop (H2), lege regel voor alinea, <code>-</code> voor bullets.
</p>

    <div class="row">
      <div>
        <label for="video_url">Video-URL (YouTube, embed of watch)</label>
        <input type="url" id="video_url" name="video_url" placeholder="https://www.youtube.com/embed/..." value="{{ post.video_url if post else '' }}">
        <p class="help muted">‚Äòwatch?v=‚Ä¶‚Äô wordt automatisch omgezet naar ‚Äòembed/‚Ä¶‚Äô</p>
      </div>
      <div>
        <label for="afbeelding">Afbeelding</label>
        <input type="file" id="afbeelding" name="afbeelding" accept="image/*">
        {% if post and post.afbeelding %}
          <p class="help">Huidig: <strong>{{ post.afbeelding }}</strong></p>
          <img src="{{ url_for('static', filename='uploads/' ~ post.afbeelding) }}" alt="Huidige afbeelding" style="max-width:180px; border-radius:6px; margin-top:8px;">
        {% endif %}
      </div>
    </div>

    <hr style="margin: 22px 0;">

    <h3>Koppel dit artikel (meerdere selecties mogelijk, alles optioneel)</h3>
    <div class="grid-3">
      <div>
        <label for="categorie_ids">Categorie√´n</label>
        <select id="categorie_ids" name="categorie_ids" multiple size="8" aria-label="Koppel categorie√´n">
          {% for c in categorieen %}
            <option value="{{ c.id }}" {{ 'selected' if post and c in post.categorieen else '' }}>
              {{ c.naam }}
            </option>
          {% endfor %}
        </select>
        <p class="help muted">Hoger niveau. Filtert subcategorie√´n & abonnementen.</p>
      </div>

      <div>
        <label for="subcategorie_ids">Subcategorie√´n</label>
        <select id="subcategorie_ids" name="subcategorie_ids" multiple size="8" aria-label="Koppel subcategorie√´n">
          {% for s in subcategorieen %}
            <option value="{{ s.id }}" data-categorie="{{ s.categorie_id }}" {{ 'selected' if post and s in post.subcategorieen else '' }}>
              {{ s.naam }}
            </option>
          {% endfor %}
        </select>
        <p class="help muted">Wordt gefilterd door gekozen categorie(√´n).</p>
      </div>

      <div>
        <label for="abonnement_ids">Abonnementen</label>
        <select id="abonnement_ids" name="abonnement_ids" multiple size="8" aria-label="Koppel abonnementen">
          {% for a in abonnementen %}
            <option value="{{ a.id }}" data-sub="{{ a.subcategorie_id }}" {{ 'selected' if post and a in post.abonnementen else '' }}>
              {{ a.naam }}
            </option>
          {% endfor %}
        </select>
        <p class="help muted">Wordt gefilterd door gekozen subcategorie(√´n).</p>
      </div>
    </div><hr style="margin: 22px 0;">
<h3>Banners (optioneel)</h3>
<p class="help muted">Kies per plek: standaard banner (afbeelding+link), HTML advertorial of rotator.</p>

{% set slots = [
  ("top", "Bovenaan (onder titel/meta)"),
  ("mid", "Midden (na afbeelding / intro)"),
  ("bottom", "Onderaan (na content)"),
  ("sidebar_right", "Sidebar rechts (sticky op desktop)"),
  ("sidebar_left", "Sidebar links (alleen zichtbaar op brede schermen)")
] %}


{% for key, label in slots %}
  {% set b = (post.banners | selectattr("slot","equalto",key) | list | first) if post and post.banners else None %}

  <div style="border:1px solid #eee; padding:14px; border-radius:8px; margin: 12px 0;">
    <strong>{{ label }}</strong>

    <label for="banner_{{ key }}_type">Type</label>
    <select id="banner_{{ key }}_type" name="banner_{{ key }}_type">
      <option value="none" {{ 'selected' if not b or b.banner_type=='none' else '' }}>Geen</option>
      <option value="image" {{ 'selected' if b and b.banner_type=='image' else '' }}>Standaard banner (afbeelding + link)</option>
      <option value="html" {{ 'selected' if b and b.banner_type=='html' else '' }}>HTML advertorial</option>
      <option value="rotator" {{ 'selected' if b and b.banner_type=='rotator' else '' }}>Rotator (meerdere banners)</option>
    </select>

    <label>Standaard banner afbeelding</label>
    <input type="file" name="banner_{{ key }}_image" accept="image/*">
    {% if b and b.image_filename %}
      <p class="help">Huidig: <strong>{{ b.image_filename }}</strong></p>
      <img src="{{ url_for('static', filename='uploads/' ~ b.image_filename) }}" style="max-width:180px;border-radius:6px;">
    {% endif %}

    <label>Link-URL (bij standaard banner)</label>
    <input type="url" name="banner_{{ key }}_link" value="{{ b.link_url if b else '' }}" placeholder="https://...">

    <label>HTML advertorial (alleen als type=HTML)</label>
    <textarea name="banner_{{ key }}_html" placeholder="Plak hier je HTML...">{{ b.html_code if b else '' }}</textarea>

    <label>Rotator afbeeldingen (meerdere selecteren)</label>
    <input type="file" name="banner_{{ key }}_rotator_images" accept="image/*" multiple>
    <p class="help muted">
      Rotator links: 1 URL per regel, in dezelfde volgorde als de uploads.
    </p>
    <textarea name="banner_{{ key }}_rotator_links" placeholder="https://adverteerder1.nl&#10;https://adverteerder2.nl"></textarea>

    <label style="margin-top:10px;">
      <input type="checkbox" name="banner_{{ key }}_active" value="1" {{ 'checked' if not b or b.is_active else '' }}>
      Actief
    </label>
  </div>
{% endfor %}

    <button type="submit" class="btn-primary">{{ 'Update' if post else 'Publiceer' }}</button>
  </form>
</div>

<script>
/**
 * CLIENT-SIDE CASCADE
 * - Filter subcategorie√´n o.b.v. gekozen categorie(√´n)
 * - Filter abonnementen o.b.v. gekozen subcategorie(√´n)
 * Werkt zonder extra API-calls (we gebruiken data-* attributen op <option>).
 */
(function(){
  const selCat = document.getElementById('categorie_ids');
  const selSub = document.getElementById('subcategorie_ids');
  const selAbo = document.getElementById('abonnement_ids');

  // Bewaar originele opties
  const allSubs = Array.from(selSub.options).map(o => ({id:o.value, cat:o.dataset.categorie, text:o.textContent, selected:o.selected}));
  const allAbos = Array.from(selAbo.options).map(o => ({id:o.value, sub:o.dataset.sub, text:o.textContent, selected:o.selected}));

  function getSelectedValues(selectEl){
    return Array.from(selectEl.selectedOptions).map(o => o.value);
  }

  function renderSubcats(){
    const catIds = new Set(getSelectedValues(selCat));
    selSub.innerHTML = '';
    let pool = allSubs;

    if (catIds.size > 0){
      pool = allSubs.filter(s => catIds.has(String(s.cat)));
    }

    pool.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.text;
      opt.dataset.categorie = s.cat;
      // behoud selectie als die nog geldig is
      if (s.selected) opt.selected = true;
      selSub.appendChild(opt);
    });

    // Bijwerken abonnementen zodra subcats veranderen
    renderAbos();
  }

  function renderAbos(){
    const subIds = new Set(getSelectedValues(selSub));
    selAbo.innerHTML = '';
    let pool = allAbos;

    if (subIds.size > 0){
      pool = allAbos.filter(a => subIds.has(String(a.sub)));
    }

    pool.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = a.text;
      opt.dataset.sub = a.sub;
      if (a.selected) opt.selected = true;
      selAbo.appendChild(opt);
    });
  }

  // On change events
  selCat.addEventListener('change', () => { 
    // snapshot huidige selecties
    const currentSubs = new Set(getSelectedValues(selSub));
    const currentAbos = new Set(getSelectedValues(selAbo));
    // regenereer
    renderSubcats();
    // probeer bestaande keuzes zoveel mogelijk te behouden
    Array.from(selSub.options).forEach(o => { if (currentSubs.has(o.value)) o.selected = true; });
    Array.from(selAbo.options).forEach(o => { if (currentAbos.has(o.value)) o.selected = true; });
  });

  selSub.addEventListener('change', () => {
    const currentAbos = new Set(getSelectedValues(selAbo));
    renderAbos();
    Array.from(selAbo.options).forEach(o => { if (currentAbos.has(o.value)) o.selected = true; });
  });

  // Init: √©√©n keer renderen zodat filtering direct klopt bij bewerken
  renderSubcats();
})();

</script>
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

<script>
  // ---------------------------
  // Helpers: vind category/subcategory in je formulier
  // ---------------------------
  const BASE_URL = "https://abbohub.nl";

  function pickValue(selectors) {
    for (const sel of selectors) {
      const el = document.querySelector(sel);
      if (el && typeof el.value === "string" && el.value.trim() !== "") {
        return el.value.trim();
      }
    }
    return "";
  }

  function getDefaultCtaUrl() {
    // Probeer categorie + subcategorie te vinden (pas gerust selectors aan naar jouw echte ids/names)
    const category = pickValue([
      "#categorie_slug", "[name='categorie_slug']",
      "#category_slug",  "[name='category_slug']",
      "#categorie",      "[name='categorie']",
      "#category",       "[name='category']"
    ]);

    const subcategory = pickValue([
      "#subcategorie_slug", "[name='subcategorie_slug']",
      "#subcategory_slug",  "[name='subcategory_slug']",
      "#subcategorie",      "[name='subcategorie']",
      "#subcategory",       "[name='subcategory']"
    ]);

    // Bouw jouw AbboHub categorie-URL structuur: /categorie/<category>/<subcategory>/
    if (category && subcategory) return `${BASE_URL}/categorie/${category}/${subcategory}/`;
    if (category) return `${BASE_URL}/categorie/${category}/`;

    // Fallback
    return `${BASE_URL}/`;
  }

  // ---------------------------
  // EasyMDE init
  // ---------------------------
  const mde = new EasyMDE({
    element: document.getElementById("inhoud"),
    spellChecker: false,
    status: ["lines", "words"],

    toolbar: [
      "bold", "italic", "strikethrough", "|",
      "heading-2", "heading-3", "|",
      "unordered-list", "ordered-list", "quote", "|",
      "link", "table", "horizontal-rule", "|",
      "preview", "side-by-side", "fullscreen", "|",

      // ‚úÖ CTA (Optie 2): URL op basis van categorie/subcategorie
      {
        name: "cta",
        title: "CTA knop (automatisch op categorie)",
        className: "fa fa-bullseye",
        action: function(editor) {
          const cm = editor.codemirror;
          const url = getDefaultCtaUrl();
          const text = "üëâ Vergelijk abonnementen";

          // NB: {: .btn-cta } werkt als je Python-Markdown 'attr_list' gebruikt
          const snippet = `[${text}](${url}){: .btn-cta }\n`;
          cm.replaceSelection(snippet);
          cm.focus();
        }
      },

      // ‚úÖ FAQ blok (uitklapbaar)
      {
        name: "faq",
        title: "FAQ blok (uitklapbaar)",
        className: "fa fa-question-circle",
        action: function(editor) {
          const cm = editor.codemirror;
          const snippet =
`<details class="faq">
  <summary>Vraag hier...</summary>

  Antwoord hier...
</details>

`;
          cm.replaceSelection(snippet);
          cm.focus();
        }
      },

      // ‚úÖ Tabel snippet (voorgevulde vergelijking)
      {
        name: "table-snippet",
        title: "Vergelijkingstabel invoegen",
        className: "fa fa-table",
        action: function(editor) {
          const cm = editor.codemirror;
          const snippet =
`| Keuze | Beste voor | Pluspunten | Minpunten |
|------|------------|------------|----------|
| Abonnement / herhaalservice | Dagelijkse koffiedrinkers | Automatisch bezorgd, vaak voordeel | Soms bijsturen (pauze/aanpassen) |
| Los kopen | Koopjesjagers & variatiezoekers | Maximale vrijheid | Meer werk, soms duurder |

`;
          cm.replaceSelection(snippet);
          cm.focus();
        }
      },

      // ‚úÖ Artikel-template
      {
        name: "template",
        title: "Plaats artikel-template",
        className: "fa fa-file",
        action: function(editor){
          const cm = editor.codemirror;
          const t =
`## Intro
Schrijf in 3-5 zinnen wat de lezer gaat leren.

## Voor wie is dit interessant?
- Punt 1
- Punt 2

## Prijs & voorwaarden
Leg prijzen / contract / opzeggen uit.

## Vergelijking
(Voeg een tabel toe met de tabelknop)

## FAQ
(Voeg FAQ-blokken toe met de FAQ-knop)

## Conclusie
Kort advies + voor wie wel/niet.
`;
          cm.replaceSelection(t);
          cm.focus();
        }
      }
    ]
  });
</script>
</body>
</html>
